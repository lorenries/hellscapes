<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#">

<head>
    <meta charset="UTF-8">
    <meta property="og:image" content="../assets/images/apocalypse6.jpg" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hellscapes: Visions of the Apocalypse</title>
    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.6.1/css/tachyons.min.css" />
    <link rel="stylesheet" href="http://d2v52k3cl9vedd.cloudfront.net/vhs/0.1.0/vhs.min.css">
    <!-- <link rel="stylesheet" href="https://unpkg.com/tippy.js/dist/css/tippy.min.css"> -->
    <link rel="icon" href="../assets/icons/gasmask.png" type="image/png">
</head>
<style>
    @font-face {
        font-family: 'reporter';
        src: url('../assets/fonts/reportr1.woff');
    }

    .reporter {
        font-family: 'reporter';
    }

    .spin--slow {
        animation: spinback 1s ease infinite;
    }

    @keyframes spinback {
        0% {
            transform: rotate(360deg);
        }
        100% {
            transform: rotate(0deg);
        }
    }

    .ripple {
      animation: ripple .5s ease infinite;
    }

    @keyframes ripple {
        0% {
            opacity: 0;
        }
        100% {
            opacity: 1;
        }
    }    

    .land{
      fill: #fff;
    }

    .border{
      stroke: #000;
      fill: none;
    }    

    .fill {
      fill: #000;
    }

    .explosion {
      fill: red;
    }

    .stroke {
      fill: none;
      stroke: #fff;
      stroke-width: 3px;
    }

    #map svg {
      height: 90vh;
      margin: 0;
      width: auto;
      max-width: 95vw;
    }

</style>

<body class="bg-black center tc">
    <div class="flex flex-column items-center justify-center justify-around-ns vh-100 ma0">
        <h1 class="db w-100 bg-black white center tc reporter f1 f-headline-ns fn ma0 pa0 fitter-happier-text">
          Hellscapes:
        </h1>
        <h2 class="db w-100 bg-black white center tc reporter f1 f-headline-ns fn ma0 pa0 fitter-happier-text">Visions of the Apocalypse</h2>
        <div id="zombie" class="pb2 pt4">
          <a href="#map" class="link db scroll">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="-1 -1 101 102" fill="none" fill-rule="evenodd" stroke="#ffffff" stroke-width="2" class="center h4 w-auto db"> 
              <path d="M90.3 19.7v-11c0-4.8-3.9-8.7-8.7-8.7H21.2c-4.8 0-8.7 3.9-8.7 8.7v1.7C5.2 13.1 0 20.1 0 28.3s5.2 15.2 12.5 17.9v45c0 4.8 3.9 8.7 8.7 8.7h60.4c4.8 0 8.7-3.9 8.7-8.7V45.4c5.2-2 8.9-7 8.9-12.8s-3.7-10.9-8.9-12.9zM5 28.3c0-7.8 6.4-14.2 14.2-14.2s14.1 6.4 14.1 14.2c0 7.9-6.3 14.2-14.2 14.2S5 36.2 5 28.3zm80.3 63c0 2.1-1.7 3.7-3.7 3.7H21.2c-2.1 0-3.7-1.7-3.7-3.7V47.4c.5.1 1.1.1 1.6.1 10.6 0 19.2-8.6 19.2-19.2S29.7 9.1 19.1 9.1c-.6 0-1.1 0-1.7.1v-.6c0-2.1 1.7-3.7 3.7-3.7h60.4c2.1 0 3.7 1.7 3.7 3.7v10.1c-7.5.1-13.6 6.2-13.6 13.7S77.7 46 85.2 46.1l.1 45.2zm.2-50c-4.8 0-8.7-3.9-8.7-8.7s3.9-8.7 8.7-8.7c4.8 0 8.7 3.9 8.7 8.7s-3.9 8.7-8.7 8.7z"/>
              <path d="M65.7 56.2H37.1c-6.1 0-11.1 5-11.1 11.1v13.1c0 6.1 5 11.1 11.1 11.1h28.6c6.1 0 11.1-5 11.1-11.1V67.3c0-6.1-5-11.1-11.1-11.1zM60.3 63c0-.8.5-1.5 1.2-1.8h1.4c.7.3 1.2 1 1.2 1.8v5.5c0 1.1-.9 2-2 2s-2-.9-2-2V63h.2zm-7.8 0c0-.8.5-1.5 1.2-1.8h1.4c.7.3 1.2 1 1.2 1.8v5.5c0 1.1-.9 2-2 2s-2-.9-2-2V63h.2zm-7.8 0c0-.8.5-1.5 1.2-1.8h1.4c.7.3 1.2 1 1.2 1.8v4.4c0 1.1-.9 2-2 2s-2-.9-2-2V63h.2zM37 63c0-.8.5-1.5 1.2-1.8h1.4c.7.3 1.2 1 1.2 1.8v5.5c0 1.1-.9 2-2 2s-2-.9-2-2V63h.2zm-6 4.3c0-1.7.7-3.3 1.9-4.4.2.3.3.6.3 1v5.9c0 1.1-.9 2-2 2H31v-4.5zm40.8 13.1c0 3.4-2.7 6.1-6.1 6.1h-3.9c-1-6-6.1-10.6-12.2-10.6s-11.2 4.5-12.2 10.6h-.3c-3.4 0-6.1-2.7-6.1-6.1v-4.8h.2c1.9 0 3.5-.9 4.6-2.3.9.6 2 1 3.2 1 1.8 0 3.4-.9 4.5-2.2.9.7 2.1 1.1 3.3 1.1s2.4-.4 3.3-1.1c1 1.3 2.7 2.2 4.5 2.2 1.5 0 2.9-.6 3.9-1.5 1 1 2.4 1.5 3.9 1.5s2.9-.6 3.9-1.5c1 1 2.4 1.5 3.9 1.5.6 0 1.2-.1 1.8-.3v6.4h-.2zm0-11.1c-.3.7-1 1.2-1.8 1.2-1.1 0-2-.9-2-2V63c0-.4.1-.8.4-1.2 2 1 3.4 3 3.4 5.4v2.1zM41.1 34.9c0-1.8-2.5-1.7-2.7 0-1 8.9-12 15.2-19.7 17.2-.6.2-.4 1 .1 1 5.4.6 10.3-2.1 14.3-5.4 3.8-3.1 8.1-7.5 8-12.8zM69.2 34.1c-.4-1.6-2.6-.9-2.4.7.6 4.4 2.8 8.6 6.2 11.5 2.4 2.1 6.4 4.7 9.4 2.3.3-.2 0-.7-.3-.7-7.2-.2-11.4-7.6-12.9-13.8z"/>
              <circle cx="15.2" cy="28.2" r="3.1"/>
              <circle cx="82.5" cy="31.3" r="3.1"/>
            </svg>
            <p class="f1 tc white grow-large">&#x2193;<p>
          </a>
        </div>
    </div>
    <div class="pt3" id="map" class="min-vh-100"></div>

    <div class="vh-100 flex items-center flex-column justify-center">            
      <p class="reporter fn f1 f-headline-ns reporter white center tc bg-black ma0 pt4">
                "I am become death, the destroyer of worlds."
      </p>

    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 77" fill="#fff" class="h5 w-auto pt4"><path
    d="M35.5 24.9c-1.1-.3-2.2-.4-3.2-.4-2.1 0-3.7.6-4.5 1.6-.6.8-.8 1.8-.5 3.1 1.5 7.1 4.1 10.2 8.3 10.2 5.4 0 7.6-1.7 7.8-6.2.2-3.1-1.8-6.9-7.9-8.3zm.3 13.1c-3.5 0-5.5-2.6-6.6-8-.8-3.6 2.8-4.5 6.6-3.7 4.5 1 6.4 3.9 6.3 6.6-.2 3.8-2.2 5.1-6.3 5.1zM17.7 24.6c-1 0-2.1.1-3.2.4-6.1 1.4-8.1 5.2-7.9 8.3.2 4.5 2.4 6.2 7.8 6.2 4.2 0 6.8-3.2 8.3-10.2.3-1.3.1-2.4-.5-3.1-.8-1.1-2.4-1.6-4.5-1.6zm3.2 5.4c-1.2 5.4-3.2 8-6.6 8-4.2 0-6.1-1.3-6.3-5-.1-2.7 1.7-5.6 6.3-6.6 3.8-.9 7.4 0 6.6 3.6z"/><path
    d="M25 0C11.2 0 0 11.2 0 25c0 7.6 3.4 14.5 8.8 19 0 0 8.2 6 8.2 17h16c0-11 8.2-17 8.2-17 5.4-4.6 8.8-11.4 8.8-19C50 11.2 38.8 0 25 0zm-1.3 29.5c-1.6 7.6-4.5 11-9.3 11-6 0-8.6-2.1-8.8-7.2-.1-3.4 2.1-7.8 8.7-9.3 1.2-.3 2.3-.4 3.4-.4 2.4 0 4.2.7 5.3 1.9.8 1 1.1 2.3.7 4zM34.8 6.6c.2.1 6 3 8.2 8.8l-1.9.7c-1.9-5.1-7.2-7.6-7.2-7.7l.9-1.8zm-4-2.1c.6 0 1.1.5 1.1 1.1s-.5 1.1-1.1 1.1-1.1-.5-1.1-1.1.5-1.1 1.1-1.1zm4.8 36c-4.8 0-7.6-3.4-9.3-11-.3-1.6-.1-2.9.7-4 1-1.3 2.8-1.9 5.3-1.9 1.1 0 2.2.1 3.4.4 6.7 1.5 8.9 6 8.7 9.3-.2 5-2.8 7.2-8.8 7.2zM9 69h32v8H9zM17 63h16v4H17z"/></svg>

    </div>
</body>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>
<script src="https://unpkg.com/d3-tip@0.7.1/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.0.2/anime.min.js"></script>
<script src="https://unpkg.com/fitter-happier-text@0.0.7/dist/fitter-happier-text.js"></script>
<script>

zombie.addEventListener("mouseout", function() {zombieBounce.play()});

(function() {

     'use strict';

    // Feature Test
    if ( 'querySelector' in document && 'addEventListener' in window && Array.prototype.forEach ) {

        // Function to animate the scroll
        var smoothScroll = function (anchor, duration) {

            // Calculate how far and how fast to scroll
            var startLocation = window.pageYOffset;
            var endLocation = anchor.offsetTop;
            var distance = endLocation - startLocation;
            var increments = distance/(duration/16);
            var stopAnimation;

            // Scroll the page by an increment, and check if it's time to stop
            var animateScroll = function () {
                window.scrollBy(0, increments);
                stopAnimation();
            };

            // If scrolling down
            if ( increments >= 0 ) {
                // Stop animation when you reach the anchor OR the bottom of the page
                stopAnimation = function () {
                    var travelled = window.pageYOffset;
                    if ( (travelled >= (endLocation - increments)) || ((window.innerHeight + travelled) >= document.body.offsetHeight) ) {
                        clearInterval(runAnimation);
                    }
                };
            }
            // If scrolling up
            else {
                // Stop animation when you reach the anchor OR the top of the page
                stopAnimation = function () {
                    var travelled = window.pageYOffset;
                    if ( travelled <= (endLocation || 0) ) {
                        clearInterval(runAnimation);
                    }
                };
            }

            // Loop the animation function
            var runAnimation = setInterval(animateScroll, 16);
       
        };

        // Define smooth scroll links
        var scrollToggle = document.querySelectorAll('.scroll');

        // For each smooth scroll link
        [].forEach.call(scrollToggle, function (toggle) {

            // When the smooth scroll link is clicked
            toggle.addEventListener('click', function(e) {

                // Prevent the default link behavior
                e.preventDefault();

                // Get anchor link and calculate distance from the top
                var dataID = toggle.getAttribute('href');
                var dataTarget = document.querySelector(dataID);
                var dataSpeed = toggle.getAttribute('data-speed');

                // If the anchor exists
                if (dataTarget) {
                    // Scroll to the anchor
                    smoothScroll(dataTarget, dataSpeed || 500);
                }

            }, false);

        });

    }

 })();

/***** ALL MATH FUNCTIONS ****/

var to_radians = Math.PI / 180;
var to_degrees = 180 / Math.PI;


// Helper function: cross product of two vectors v0&v1
function cross(v0, v1) {
    return [v0[1] * v1[2] - v0[2] * v1[1], v0[2] * v1[0] - v0[0] * v1[2], v0[0] * v1[1] - v0[1] * v1[0]];
}

//Helper function: dot product of two vectors v0&v1
function dot(v0, v1) {
    for (var i = 0, sum = 0; v0.length > i; ++i) sum += v0[i] * v1[i];
    return sum;
}

// Helper function: 
// This function converts a [lon, lat] coordinates into a [x,y,z] coordinate 
// the [x, y, z] is Cartesian, with origin at lon/lat (0,0) center of the earth
function lonlat2xyz( coord ){

  var lon = coord[0] * to_radians;
  var lat = coord[1] * to_radians;

  var x = Math.cos(lat) * Math.cos(lon);

  var y = Math.cos(lat) * Math.sin(lon);

  var z = Math.sin(lat);

  return [x, y, z];
}

// Helper function: 
// This function computes a quaternion representation for the rotation between to vectors
// https://en.wikipedia.org/wiki/Rotation_formalisms_in_three_dimensions#Euler_angles_.E2.86.94_Quaternion
function quaternion(v0, v1) {

  if (v0 && v1) {
    
      var w = cross(v0, v1),  // vector pendicular to v0 & v1
          w_len = Math.sqrt(dot(w, w)); // length of w     

        if (w_len == 0)
          return;

        var theta = .5 * Math.acos(Math.max(-1, Math.min(1, dot(v0, v1)))),

          qi  = w[2] * Math.sin(theta) / w_len; 
          qj  = - w[1] * Math.sin(theta) / w_len; 
          qk  = w[0]* Math.sin(theta) / w_len;
          qr  = Math.cos(theta);

      return theta && [qr, qi, qj, qk];
  }
}

// Helper function: 
// This functions converts euler angles to quaternion
// https://en.wikipedia.org/wiki/Rotation_formalisms_in_three_dimensions#Euler_angles_.E2.86.94_Quaternion
function euler2quat(e) {

  if(!e) return;
    
    var roll = .5 * e[0] * to_radians,
        pitch = .5 * e[1] * to_radians,
        yaw = .5 * e[2] * to_radians,

        sr = Math.sin(roll),
        cr = Math.cos(roll),
        sp = Math.sin(pitch),
        cp = Math.cos(pitch),
        sy = Math.sin(yaw),
        cy = Math.cos(yaw),

        qi = sr*cp*cy - cr*sp*sy,
        qj = cr*sp*cy + sr*cp*sy,
        qk = cr*cp*sy - sr*sp*cy,
        qr = cr*cp*cy + sr*sp*sy;

    return [qr, qi, qj, qk];
}

// This functions computes a quaternion multiply
// Geometrically, it means combining two quant rotations
// http://www.euclideanspace.com/maths/algebra/realNormedAlgebra/quaternions/arithmetic/index.htm
function quatMultiply(q1, q2) {
  if(!q1 || !q2) return;

    var a = q1[0],
        b = q1[1],
        c = q1[2],
        d = q1[3],
        e = q2[0],
        f = q2[1],
        g = q2[2],
        h = q2[3];

    return [
     a*e - b*f - c*g - d*h,
     b*e + a*f + c*h - d*g,
     a*g - b*h + c*e + d*f,
     a*h + b*g - c*f + d*e];

}

// This function computes quaternion to euler angles
// https://en.wikipedia.org/wiki/Rotation_formalisms_in_three_dimensions#Euler_angles_.E2.86.94_Quaternion
function quat2euler(t){

  if(!t) return;

  return [ Math.atan2(2 * (t[0] * t[1] + t[2] * t[3]), 1 - 2 * (t[1] * t[1] + t[2] * t[2])) * to_degrees, 
       Math.asin(Math.max(-1, Math.min(1, 2 * (t[0] * t[2] - t[3] * t[1])))) * to_degrees, 
       Math.atan2(2 * (t[0] * t[3] + t[1] * t[2]), 1 - 2 * (t[2] * t[2] + t[3] * t[3])) * to_degrees
      ]
}

/*  This function computes the euler angles when given two vectors, and a rotation
  This is really the only math function called with d3 code.

  v0 - starting pos in lon/lat, commonly obtained by projection.invert
  v1 - ending pos in lon/lat, commonly obtained by projection.invert
  o0 - the projection rotation in euler angles at starting pos (v0), commonly obtained by projection.rotate
*/

function eulerAngles(v0, v1, o0) {

  /*
    The math behind this:
    - first calculate the quaternion rotation between the two vectors, v0 & v1
    - then multiply this rotation onto the original rotation at v0
    - finally convert the resulted quat angle back to euler angles for d3 to rotate
  */

  var t = quatMultiply( euler2quat(o0), quaternion(lonlat2xyz(v0), lonlat2xyz(v1) ) );
  return quat2euler(t); 
}


/**************end of math functions**********************/


var width = 600,
    height = 600;
    r = 300;

var projection = d3.geo.orthographic()
    .scale(300)
    .translate([width / 2, height / 2])
    .clipAngle(90);

var path = d3.geo.path()
    .projection(projection);

// projection.center(path([-98.583333, 39.833333]));

var svg = d3.select("#map").append("svg")
    .attr("viewBox", "0 0 " + width + " " + height);
    // .attr("width", width)
    // .attr("height", height);

var publicSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/1MHhYJzgdI2xNKoQum8Ec7S1k86wm_LfMr3PNw4GPmL8/pubhtml';

svg.append("defs").append("path")
    .datum({type: "Sphere"})
    .attr("id", "sphere")
    .attr("d", path);

svg.append("use")
    .attr("class", "stroke")
    .attr("xlink:href", "#sphere");

svg.append("use")
    .attr("class", "fill")
    .attr("xlink:href", "#sphere");

var drag = d3.behavior.drag()
      .on("dragstart", dragstarted)
      .on("drag", dragged)
      .on("dragend", dragended);

svg.call(drag);

var gpos0, o0;

function dragstarted(){

  gpos0 = projection.invert(d3.mouse(this));
  o0 = projection.rotate();

  svg.insert("path")
             .datum({type: "Point", coordinates: gpos0})
             .attr("class", "point")
             .attr("d", path); 
}

function dragged(){

  var gpos1 = projection.invert(d3.mouse(this));

  o0 = projection.rotate();

  var o1 = eulerAngles(gpos0, gpos1, o0);
  projection.rotate(o1);

  svg.selectAll(".point")
      .datum({type: "Point", coordinates: gpos1});
  svg.selectAll("path").attr("d", path);

  svg.selectAll(".explosion")
    .attr("d", circlePoint)

  svg.selectAll("circle")
    .attr("cx", function (d) { return projection(d)[0]; })
    .attr("cy", function (d) { return projection(d)[1]; })

}

function dragended(){
  svg.selectAll(".point").remove();
}

function initSpreadsheet() {
  Tabletop.init( { key: publicSpreadsheetUrl,
    callback: printDataOntoMap,
    simpleSheet: true } )
  }


function printDataOntoMap(data, tabletop) {
  console.log(data);
  svg.selectAll("path.explosion")
    .data(data).enter()
    .append("path")
    .attr("class", "explosion")
    .attr("d", function(d) {return circlePoint(d)})
    .on('mouseover', tip.show)
    .on('mouseout', tip.hide);
}

function circlePoint(data) {
  return path({"type": "Point", "coordinates": [data.lon, data.lat]})
}

tip = d3.tip()
  .attr('class', 'd3-tip')
  .html(function(d) { 
    return `
    <div>
      <iframe width="560" height="315" src="${d.url}&amp;controls=0&amp;showinfo=0&autoplay=1" frameborder="0" allowfullscreen></iframe>
    </div>`;
  });

svg.call(tip);

d3.json("https://unpkg.com/world-atlas@1/world/110m.json", function(error, world){
  if (error) throw error;

  svg.append("path")
      .datum(topojson.feature(world, world.objects.land))
      .attr("class", "land")
      .attr("d", path);

  borders = topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; });

  svg.append("path")
    .datum(borders)
    .attr("class", "border")
    .attr("d", path);

  initSpreadsheet();

});

</script>

</html>
